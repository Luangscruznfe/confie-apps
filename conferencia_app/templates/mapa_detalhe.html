<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa {{ numero_carga }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1115; --panel: #161a22; --panel-2: #121722; --ink: #ecf2ff;
            --muted: #b9c3d6; --line: #2a364a; --ok: #1f9d61; --ok-bg: rgba(35, 171, 103, .18);
            --err: #ef4444; --err-bg: rgba(239, 68, 68, .18); --warn: #ffd166; --warn-bg: rgba(255, 209, 102, .18);
            --input-bg: #0f141b; --input-line: #2a3b5e; --chip: #233049;
        }
        body { background-color: var(--bg); color: var(--ink); }
        .card { background-color: var(--panel); border-color: var(--line); }
        .card-header { background-color: var(--panel-2); font-weight: 700; border-bottom-color: var(--line); }
        .list-group-item { background-color: var(--panel); border-color: #222c3f; }
        .list-group-item.separado { background-color: var(--ok-bg); }
        .list-group-item.faltou { background-color: var(--err-bg); }
        .list-group-item.pendente { background-color: var(--warn-bg); } /* Novo estilo para pendente */
        .form-control, .input-group-text, .modal-content {
            background-color: var(--input-bg); color: var(--ink); border-color: var(--input-line);
        }
        .form-control:focus {
            background-color: var(--input-bg); color: var(--ink); border-color: var(--warn);
            box-shadow: 0 0 0 0.25rem rgba(255, 209, 102, 0.25);
        }
        .btn-close { filter: invert(1); }
        .sticky-top-bar { position: sticky; top: 0; z-index: 1020; background: var(--bg); padding: .75rem 0; }
        .small-mono { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 0.9rem; }
        .form-check-input:checked { background-color: var(--ok); border-color: var(--ok); }
    </style>
</head>
<body>
<div class="container py-3">
    <nav class="mb-3">
        <a class="btn btn-outline-light me-2" href="/mapa">← Mapas</a>
        <a class="btn btn-outline-light me-2" href="/gestao">Gestão</a>
        <a class="btn btn-outline-light" href="/conferencia">Conferência</a>
    </nav>
    <div class="sticky-top-bar">
        <h3 class="mb-2">{{ nome_mapa or 'Mapa' }} <span class="text-info">{{ numero_carga }}</span></h3>
        <input id="busca" class="form-control" placeholder="Buscar por código, EAN ou descrição...">
        <div id="resumo" class="text-secondary small mt-2"></div>
    </div>
    <div id="grupos-container" class="mt-3">
        <p class="text-center text-secondary">A carregar itens do mapa...</p>
    </div>
</div>

<div class="modal fade" id="modalFaltou" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalFaltouLabel">Registrar Falta Parcial</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Produto: <strong id="modal-produto-nome"></strong></p>
                <p>Pedido: <span id="modal-qtd-pedida" class="fw-bold text-info"></span></p>
                <div class="mb-3">
                    <label for="modal-qtd-separada" class="form-label">Quantidade que foi separada:</label>
                    <input type="number" class="form-control" id="modal-qtd-separada" placeholder="Ex: 9">
                </div>
                <input type="hidden" id="modal-item-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarFalta()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const NUMERO_CARGA = {{ numero_carga | tojson }};
    let STATE = { grupos: [], itens: [] };
    let modalFaltou;

    function badge(text, className) { return `<span class="badge ${className} me-1">${text}</span>`; }

    function renderItens() {
        const container = document.getElementById('grupos-container');
        const query = document.getElementById('busca').value.toLowerCase().trim();
        let html = '';
        let total = 0, marcados = 0;

        STATE.grupos.forEach(grupo => {
            const itensFiltrados = STATE.itens.filter(it => {
                if (it.grupo_codigo !== grupo.grupo_codigo) return false;
                if (!query) return true;
                const searchable = `${it.codigo || ''} ${it.cod_barras || ''} ${it.descricao || ''}`.toLowerCase();
                return searchable.includes(query);
            });

            if (itensFiltrados.length === 0) return;

            const nomeSeparador = grupo.separador_nome || '';

            html += `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    
                        <div class="fw-bold fs-5">
                            <span>${grupo.grupo_codigo}</span>
                            <span class="text-white-50">${grupo.grupo_titulo || ''}</span>
                        </div>

                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <div class="input-group input-group-sm" style="width: auto;">
                                <span class="input-group-text">Separador:</span>
                                <input type="text" class="form-control" id="separador-${grupo.grupo_codigo}" value="${nomeSeparador}" style="min-width: 120px;">
                                <button class="btn btn-outline-info" onclick="salvarSeparador('${grupo.grupo_codigo}')">Salvar</button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-success" onclick="marcarGrupo('${grupo.grupo_codigo}', true)">Marcar</button>
                                <button class="btn btn-outline-light" onclick="marcarGrupo('${grupo.grupo_codigo}', false)">Desmarcar</button>
                            </div>
                        </div>

                    </div>
                    <div class="list-group list-group-flush">`;

            itensFiltrados.forEach(it => {
                total++;
                if (it.separado) marcados++;

                let itemClasses = "list-group-item d-flex flex-column flex-md-row justify-content-between gap-3 p-3";
                if (it.separado) itemClasses += " separado";
                if (it.faltou) itemClasses += " faltou";
                if (it.pendente) itemClasses += " pendente"; // Adiciona classe para pendente

                const descCompleta = [it.cod_barras, it.codigo, it.descricao, it.fabricante].filter(Boolean).join(' ');
                const qtdPedida = `${it.qtd_unidades || ''} ${it.unidade || ''} ${it.pack_qtd > 1 ? `(C/${it.pack_qtd})` : ''}`.trim();
                const qtdInfo = it.faltou && it.qtd_separada != null ?
                    `<span class="text-danger">Separado: ${it.qtd_separada} de ${it.qtd_unidades}</span>` :
                    `<span class="text-info">${qtdPedida}</span>`;

                html += `
                    <div class="${itemClasses}" id="item-${it.id}">
                        <div class="flex-grow-1">
                            <div class="small-mono text-light">${descCompleta}</div>
                            <div class="fw-bold">${qtdInfo}</div>
                            <div class="mt-1">
                                ${it.separado ? badge('Separado', 'bg-success') : ''}
                                ${it.faltou ? badge('Faltou', 'bg-danger') : ''}
                                ${it.pendente ? badge('Pendente', 'bg-warning text-dark') : ''} </div>
                        </div>
                        <div class="d-flex flex-wrap gap-3 align-items-center">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" ${it.separado ? 'checked' : ''} onchange="atualizarItem(${it.id}, { separado: this.checked, pendente: false })">
                                <label class="form-check-label ${it.separado ? 'text-success fw-bold' : 'text-secondary'}">OK</label>
                            </div>
                            <button class="btn btn-sm btn-warning" onclick="abrirModalFaltou(${it.id})">Faltou</button>
                            <button class="btn btn-sm btn-info text-dark" onclick="marcarPendente(${it.id}, ${!it.pendente})">OBS</button> </div>
                    </div>`;
            });
            html += `</div></div>`;
        });

        container.innerHTML = html || '<div class="alert alert-secondary">Nenhum item encontrado para a busca.</div>';
        document.getElementById('resumo').textContent = total > 0 ? `${marcados} de ${total} itens marcados.` : '';
    }

    function abrirModalFaltou(itemId) {
        const item = STATE.itens.find(it => it.id === itemId);
        if (!item) return;

        document.getElementById('modal-produto-nome').textContent = item.descricao || 'N/D';
        document.getElementById('modal-qtd-pedida').textContent = `${item.qtd_unidades || 0} ${item.unidade || ''}`;
        document.getElementById('modal-qtd-separada').value = item.qtd_separada || '';
        document.getElementById('modal-item-id').value = itemId;

        modalFaltou.show();
    }

    async function salvarFalta() {
        const itemId = parseInt(document.getElementById('modal-item-id').value, 10);
        const qtdSeparadaInput = document.getElementById('modal-qtd-separada').value;

        if (qtdSeparadaInput === '' || isNaN(parseInt(qtdSeparadaInput, 10))) {
            alert('Por favor, insira uma quantidade numérica válida.');
            return;
        }
        const qtdSeparada = parseInt(qtdSeparadaInput, 10);

        const item = STATE.itens.find(it => it.id === itemId);
        if (!item) {
            alert('Erro: Item não encontrado.');
            return;
        }

        const qtdPedida = item.qtd_unidades || 0;

        const patch = {
            qtd_separada: qtdSeparada,
            faltou: qtdSeparada < qtdPedida,
            separado: true,
            pendente: false // Se marcou falta, não está mais pendente
        };

        await atualizarItem(itemId, patch);
        modalFaltou.hide();
    }
    
    // Nova função para marcar/desmarcar item como pendente
    async function marcarPendente(itemId, pendente) {
        const item = STATE.itens.find(it => it.id === itemId);
        if (!item) return;

        const patch = {
            pendente: pendente,
            separado: false, // Se está pendente, não está separado
            faltou: false,   // Se está pendente, não está com falta (é outro tipo de problema)
            qtd_separada: null // Reseta quantidade separada se estiver pendente
        };
        
        await atualizarItem(itemId, patch);
    }

    async function salvarSeparador(grupoCodigo) {
        const input = document.getElementById(`separador-${grupoCodigo}`);
        const nome = input.value;
        
        const grupo = STATE.grupos.find(g => g.grupo_codigo === grupoCodigo);
        if(grupo) grupo.separador_nome = nome;

        await fetch('/api/mapa/grupo/definir-separador', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                numero_carga: NUMERO_CARGA,
                grupo_codigo: grupoCodigo,
                separador_nome: nome 
            })
        });
        input.classList.add('is-valid');
        setTimeout(() => input.classList.remove('is-valid'), 2000);
    }

    async function atualizarItem(itemId, patch) {
        const item = STATE.itens.find(it => it.id === itemId);
        if (item) Object.assign(item, patch);
        renderItens(); // Renderiza imediatamente com o estado local atualizado

        const response = await fetch('/api/mapa/item/atualizar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id: itemId, ...patch })
        });
        const data = await response.json();
        
        if (data.ok && data.updated_fields) {
            // Se o servidor retornar campos atualizados (ex: recalculou status),
            // atualiza o estado novamente e renderiza.
            if (item) Object.assign(item, data.updated_fields);
            renderItens();
        }
    }
    
    async function marcarGrupo(grupoCodigo, separado) {
        STATE.itens.forEach(it => { 
            if (it.grupo_codigo === grupoCodigo) {
                it.separado = separado; 
                it.pendente = false; // Ao marcar/desmarcar grupo, remove pendência
                it.faltou = false;   // Ao marcar/desmarcar grupo, remove falta
                it.qtd_separada = null; // Reseta qtd separada
            }
        });
        renderItens();

        await fetch('/api/mapa/grupo/marcar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numero_carga: NUMERO_CARGA, grupo_codigo: grupoCodigo, separado: separado })
        });
    }

    async function carregarDados() {
        try {
            const response = await fetch(`/api/mapa/${NUMERO_CARGA}`);
            if (!response.ok) throw new Error('Falha ao carregar os dados do mapa.');
            const data = await response.json();
            STATE.grupos = data.grupos || [];
            STATE.itens = data.itens || [];
            renderItens();
        } catch (error) {
            document.getElementById('grupos-container').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }

    document.getElementById('busca').addEventListener('input', renderItens);
    document.addEventListener('DOMContentLoaded', () => {
        modalFaltou = new bootstrap.Modal(document.getElementById('modalFaltou'));
        carregarDados();
    });
</script>
</body>
</html>