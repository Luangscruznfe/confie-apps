<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const NUMERO_CARGA = {{ numero_carga | tojson }};
    let STATE = { grupos: [], itens: [] };
    let modalFaltou;
    let activeFilter = 'todos';

    function setFilter(filterType) {
        activeFilter = filterType;
        document.querySelectorAll('.filter-pill').forEach(pill => pill.classList.remove('active'));
        document.getElementById(`filter-${filterType}`).classList.add('active');
        renderItens();
    }

    function badge(text, className) { return `<span class="badge ${className} me-1">${text}</span>`; }

    function renderItens() {
        const container = document.getElementById('grupos-container');
        const query = document.getElementById('busca').value.toLowerCase().trim();
        let html = '';
        let total = 0, marcados = 0;

        STATE.grupos.forEach(grupo => {
            const itensFiltrados = STATE.itens.filter(it => {
                if (it.grupo_codigo !== grupo.grupo_codigo) return false;

                if (query) {
                    const searchable = `${it.codigo || ''} ${it.cod_barras || ''} ${it.descricao || ''}`.toLowerCase();
                    if (!searchable.includes(query)) return false;
                }

                switch (activeFilter) {
                    case 'falta':
                        if (it.faltou !== true) return false;
                        break;
                    case 'obs':
                        if (!it.observacao || it.observacao.trim() === '') return false;
                        break;
                }
                return true;
            });

            if (itensFiltrados.length === 0) return;
            const nomeSeparador = grupo.separador_nome || '';
            html += `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div class="fs-5 grupo-titulo">
                            <strong class="fw-bold me-1">${grupo.grupo_codigo}</strong>
                            <span>${grupo.grupo_titulo || ''}</span>
                        </div>
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <div class="input-group input-group-sm" style="width: auto;">
                                <span class="input-group-text">Separador:</span>
                                <input type="text" class="form-control" id="separador-${grupo.grupo_codigo}" value="${nomeSeparador}" style="min-width: 120px;">
                                <button class="btn btn-outline-info" onclick="salvarSeparador('${grupo.grupo_codigo}')">Salvar</button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-success" onclick="marcarGrupo('${grupo.grupo_codigo}', true)">Marcar</button>
                                <button class="btn btn-outline-light" onclick="marcarGrupo('${grupo.grupo_codigo}', false)">Desmarcar</button>
                            </div>
                        </div>
                    </div>
                    <div class="list-group list-group-flush">`;

            itensFiltrados.forEach(it => {
                total++;
                if (it.separado) marcados++;
                let itemClasses = "list-group-item d-flex flex-column flex-md-row justify-content-between gap-3 p-3";
                if (it.separado) itemClasses += " separado";
                if (it.faltou) itemClasses += " faltou";
                if (it.pendente) itemClasses += " pendente";
                const descCompleta = [it.cod_barras, it.codigo, it.descricao, it.fabricante].filter(Boolean).join(' ');
                const qtdPedida = `${it.qtd_unidades || ''} ${it.unidade || ''} ${it.pack_qtd > 1 ? `(C/${it.pack_qtd})` : ''}`.trim();
                const qtdInfo = it.faltou && it.qtd_separada != null ?
                    `<span class="text-danger">Separado: ${it.qtd_separada} de ${it.qtd_unidades}</span>` :
                    `<span class="text-info">${qtdPedida}</span>`;
                const obsInfo = it.observacao ? `<div class="small text-warning mt-2"><strong>OBS:</strong> ${it.observacao}</div>` : '';
                html += `
                    <div class="${itemClasses}" id="item-${it.id}">
                        <div class="flex-grow-1">
                            <div class="small-mono">${descCompleta}</div>
                            <div class="fw-bold">${qtdInfo}</div>
                            ${obsInfo}
                            <div class="mt-2">
                                ${it.separado ? badge('Separado', 'bg-success') : ''}
                                ${it.faltou ? badge('Faltou', 'bg-danger') : ''}
                                ${it.pendente ? badge('Pendente', 'bg-warning text-dark') : ''}
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-3 align-items-center">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" ${it.separado ? 'checked' : ''} onchange="atualizarItem(${it.id}, { separado: this.checked, pendente: false, observacao: '' })">
                                <label class="form-check-label ${it.separado ? 'text-success fw-bold' : 'text-secondary'}">OK</label>
                            </div>
                            <button class="btn btn-sm btn-warning" onclick="abrirModalFaltou(${it.id})">Faltou</button>
                            <button class="btn btn-sm btn-info text-dark" onclick="marcarPendente(${it.id}, ${!it.pendente})">OBS</button>
                        </div>
                    </div>`;
            });
            html += `</div></div>`;
        });
        container.innerHTML = html || '<div class="alert alert-secondary">Nenhum item encontrado. Verifique a busca e o filtro selecionado.</div>';
        document.getElementById('resumo').textContent = total > 0 ? `${marcados} de ${total} itens marcados.` : '';
    }

    function abrirModalFaltou(itemId) {
        const item = STATE.itens.find(it => it.id === itemId);
        if (!item) return;
        document.getElementById('modal-produto-nome').textContent = item.descricao || 'N/D';
        document.getElementById('modal-qtd-pedida').textContent = `${item.qtd_unidades || 0} ${item.unidade || ''}`;
        document.getElementById('modal-qtd-separada').value = item.qtd_separada || '';
        document.getElementById('modal-item-id').value = itemId;
        document.getElementById('modal-observacao').value = item.observacao || '';
        modalFaltou.show();
    }

    async function salvarFalta() {
        const itemId = parseInt(document.getElementById('modal-item-id').value, 10);
        const qtdSeparadaInput = document.getElementById('modal-qtd-separada').value;
        const observacao = document.getElementById('modal-observacao').value.trim();
        if (qtdSeparadaInput === '' || isNaN(parseInt(qtdSeparadaInput, 10))) {
            alert('Por favor, insira uma quantidade num√©rica v√°lida.');
            return;
        }
        const qtdSeparada = parseInt(qtdSeparadaInput, 10);
        const item = STATE.itens.find(it => it.id === itemId);
        if (!item) { alert('Erro: Item n√£o encontrado.'); return; }
        const qtdPedida = item.qtd_unidades || 0;
        const patch = {
            qtd_separada: qtdSeparada,
            faltou: qtdSeparada < qtdPedida,
            separado: true,
            pendente: false,
            observacao: observacao
        };
        await atualizarItem(itemId, patch);
        modalFaltou.hide();
    }
    
    async function marcarPendente(itemId, pendente) {
        const item = STATE.itens.find(it => it.id === itemId);
        if (!item) return;
        const patch = {
            pendente: pendente,
            separado: false, 
            faltou: false,   
            qtd_separada: null,
            observacao: pendente ? (item.observacao || 'Item n√£o encontrado pelo separador.') : ''
        };
        await atualizarItem(itemId, patch);
    }

    async function salvarSeparador(grupoCodigo) {
        const input = document.getElementById(`separador-${grupoCodigo}`);
        const nome = input.value;
        const grupo = STATE.grupos.find(g => g.grupo_codigo === grupoCodigo);
        if(grupo) grupo.separador_nome = nome;
        await fetch('/api/mapa/grupo/definir-separador', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                numero_carga: NUMERO_CARGA,
                grupo_codigo: grupoCodigo,
                separador_nome: nome 
            })
        });
        input.classList.add('is-valid');
        setTimeout(() => input.classList.remove('is-valid'), 2000);
    }

    async function atualizarItem(itemId, patch) {
        const item = STATE.itens.find(it => it.id === itemId);
        if (item) Object.assign(item, patch);
        renderItens();
        const response = await fetch('/api/mapa/item/atualizar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id: itemId, ...patch })
        });
        const data = await response.json();
        if (data.ok && data.updated_fields) {
            if (item) Object.assign(item, data.updated_fields);
            renderItens();
        }
    }
    
    async function marcarGrupo(grupoCodigo, separado) {
        STATE.itens.forEach(it => { 
            if (it.grupo_codigo === grupoCodigo) {
                it.separado = separado; 
                it.pendente = false; 
                it.faltou = false;   
                it.qtd_separada = null; 
                it.observacao = '';
            }
        });
        renderItens();
        await fetch('/api/mapa/grupo/marcar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numero_carga: NUMERO_CARGA, grupo_codigo: grupoCodigo, separado: separado })
        });
    }

    async function carregarDados() {
        try {
            const response = await fetch(`/api/mapa/${NUMERO_CARGA}`);
            if (!response.ok) throw new Error('Falha ao carregar os dados do mapa.');
            const data = await response.json();
            STATE.grupos = data.grupos || [];
            STATE.itens = data.itens || [];
            renderItens();
        } catch (error) {
            document.getElementById('grupos-container').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }

    const themeToggle = document.getElementById('theme-toggle');

    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        if (theme === 'light') {
            themeToggle.innerHTML = 'üåô';
        } else {
            themeToggle.innerHTML = '‚òÄÔ∏è';
        }
    }

    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
    });

    // ===== PONTO DA CORRE√á√ÉO AQUI =====
    // Nova fun√ß√£o para lidar com a busca
    function handleSearchInput() {
        // Se o filtro ativo n√£o for 'todos', muda para 'todos'
        if (activeFilter !== 'todos') {
            setFilter('todos'); // Isso j√° vai chamar o renderItens()
        } else {
            renderItens(); // Se j√° estiver em 'todos', apenas renderiza
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        modalFaltou = new bootstrap.Modal(document.getElementById('modalFaltou'));
        const savedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);
        carregarDados();
        setFilter('todos');
        
        // O event listener da busca agora chama a nova fun√ß√£o
        document.getElementById('busca').addEventListener('input', handleSearchInput);
    });
</script>
</body>
</html>