<!DOCTYPE html>
<html lang="pt-br" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa {{ numero_carga }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* TEMA ESCURO (Padr√£o) */
        :root {
            --bg: #0f1115; --panel: #161a22; --panel-2: #121722; --ink: #ecf2ff;
            --muted: #b9c3d6; --line: #2a364a; --ok: #1f9d61; --ok-bg: rgba(35, 171, 103, .18);
            --err: #ef4444; --err-bg: rgba(239, 68, 68, .18); --warn: #ffd166; --warn-bg: rgba(255, 209, 102, .18);
            --input-bg: #0f141b; --input-line: #2a3b5e; --chip: #233049;
            --text-info-color: #0ea5e9;
        }
        /* TEMA CLARO */
        html[data-theme='light'] {
            --bg: #f8f9fa; --panel: #ffffff; --panel-2: #f8f9fa; --ink: #212529;
            --muted: #6c757d; --line: #dee2e6; --ok: #198754; --ok-bg: #d1e7dd;
            --err: #dc3545; --err-bg: #f8d7da; --warn: #ffc107; --warn-bg: #fff3cd;
            --input-bg: #ffffff; --input-line: #ced4da; --chip: #e9ecef;
            --text-info-color: #0d6efd;
        }
        body {
            background-color: var(--bg);
            color: var(--ink);
            transition: background-color 0.3s, color 0.3s;
        }
        /* ===== PONTO DA CORRE√á√ÉO 1: REMO√á√ÉO DO C√ìDIGO ANTIGO ===== */
        /* #grupos-container (counter-reset) e .card::before foram removidos */
        .card, .list-group-item, .modal-content {
            background-color: var(--panel);
            border-color: var(--line);
            color: var(--ink);
        }
        .card-header {
            background-color: var(--panel-2);
            border-bottom-color: var(--line);
        }
        .sticky-top-bar { background-color: var(--bg); }
        .form-control, .input-group-text, textarea.form-control {
            background-color: var(--input-bg);
            color: var(--ink);
            border-color: var(--input-line);
        }
        .form-control::placeholder { color: var(--muted); }
        .form-control:focus, textarea.form-control:focus {
            background-color: var(--input-bg);
            color: var(--ink);
            border-color: var(--warn);
            box-shadow: 0 0 0 0.25rem rgba(255, 209, 102, 0.25);
        }
        .list-group-item.separado { background-color: var(--ok-bg); }
        .list-group-item.faltou { background-color: var(--err-bg); }
        .list-group-item.pendente { background-color: var(--warn-bg); }
        .form-check-input:checked { background-color: var(--ok); border-color: var(--ok); }
        .btn-close { filter: var(--btn-close-filter, invert(1)); }
        html[data-theme='light'] .btn-close { --btn-close-filter: none; }
        .text-info { color: var(--text-info-color) !important; }
        .small-mono { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 1rem; font-weight: bold; color: var(--ink); }
        html[data-theme='light'] .small-mono { font-size: 0.95rem; }
        .grupo-titulo { color: #ffa500; font-weight: 700; letter-spacing: .3px; }
        html[data-theme='light'] .grupo-titulo { color: #d9480f; }
        .filter-pill {
            display: inline-block; padding: 0.25rem 0.75rem; background-color: var(--chip); color: var(--ink);
            border-radius: 1rem; cursor: pointer; font-size: 0.85rem;
            transition: background-color 0.2s; border: 1px solid transparent;
        }
        .filter-pill.active {
            background-color: var(--warn); color: var(--bg);
            font-weight: 600; border-color: var(--warn);
        }
        .btn-outline-light { border-color: var(--line); color: var(--muted); }
        .btn-outline-info { border-color: var(--text-info-color); color: var(--text-info-color); }
        .btn-outline-info:hover { background-color: var(--text-info-color); color: var(--bg); }
        html[data-theme='light'] .btn-info.text-dark { background-color: #0dcaf0; border-color: #0dcaf0; color: #000 !important; }

        /* ===== PONTO DA CORRE√á√ÉO 2: NOVO ESTILO PARA O N√öMERO DO GRUPO ===== */
        .group-number {
            /* Estilo da "bolinha" */
            background-color: var(--warn);
            color: var(--bg); /* Usa a cor de fundo para o texto ter contraste */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            
            /* Alinhamento do n√∫mero dentro da bolinha */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            
            /* Fonte */
            font-size: 1.1rem;
            font-weight: bold;
            flex-shrink: 0; /* Impede que a bolinha achate */
        }
    </style>
</head>
<body>

<script>
    (function() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
    })();
</script>

<div class="container py-3">
    <nav class="mb-3 d-flex justify-content-between align-items-center">
        <div>
            <a class="btn btn-outline-light me-2" href="/mapa">‚Üê Mapas</a>
            <a class="btn btn-outline-light me-2" href="/gestao">Gest√£o</a>
            <a class="btn btn-outline-light" href="/conferencia">Confer√™ncia</a>
        </div>
        <button id="theme-toggle" class="btn btn-outline-light">‚òÄÔ∏è</button>
    </nav>
    <div class="sticky-top-bar">
        <h3 class="mb-2">{{ nome_mapa or 'Mapa' }} <span class="text-info">{{ numero_carga }}</span></h3>
        <input id="busca" class="form-control" placeholder="Buscar por c√≥digo, EAN ou descri√ß√£o...">
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="d-flex gap-2">
                <span class="filter-pill" id="filter-todos" onclick="setFilter('todos')">Todos</span>
                <span class="filter-pill" id="filter-falta" onclick="setFilter('falta')">Com Falta</span>
                <span class="filter-pill" id="filter-obs" onclick="setFilter('obs')">Com OBS</span>
            </div>
            <a href="{{ url_for('mapa_detalhe_print', numero_carga=numero_carga) }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                Vers√£o para Impress√£o
            </a>
        </div>

        <div id="resumo" class="text-secondary small mt-2"></div>
    </div>
    <div id="grupos-container" class="mt-3">
        <p class="text-center text-secondary">A carregar itens do mapa...</p>
    </div>
</div>

<div class="modal fade" id="modalFaltou" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalFaltouLabel">Registrar Falta / Corte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Produto: <strong id="modal-produto-nome"></strong></p>
                <p>Pedido: <span id="modal-qtd-pedida" class="fw-bold text-info"></span></p>
                <div class="mb-3">
                    <label for="modal-qtd-separada" class="form-label">Quantidade que foi separada:</label>
                    <input type="number" class="form-control" id="modal-qtd-separada" placeholder="Ex: 9">
                </div>
                <div class="mb-3">
                    <label for="modal-observacao" class="form-label">Observa√ß√£o (Opcional):</label>
                    <textarea class="form-control" id="modal-observacao" rows="2" placeholder="Ex: Caixa avariada, produto vencido..."></textarea>
                </div>
                <input type="hidden" id="modal-item-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarFalta()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const NUMERO_CARGA = {{ numero_carga | tojson }};
    let STATE = { grupos: [], itens: [] };
    let modalFaltou;
    let activeFilter = 'todos';

    function setFilter(filterType) {
        activeFilter = filterType;
        document.querySelectorAll('.filter-pill').forEach(pill => pill.classList.remove('active'));
        document.getElementById(`filter-${filterType}`).classList.add('active');
        renderItens();
    }

    function badge(text, className) { return `<span class="badge ${className} me-1">${text}</span>`; }

    function renderItens() {
        const container = document.getElementById('grupos-container');
        const query = document.getElementById('busca').value.toLowerCase().trim();
        let html = '';
        let total = 0, marcados = 0;
        
        // ===== PONTO DA CORRE√á√ÉO 3: L√ìGICA DO N√öMERO NO JAVASCRIPT =====
        let groupCounter = 0; // Inicia o contador manual de grupos

        STATE.grupos.forEach(grupo => {
            const itensFiltrados = STATE.itens.filter(it => {
                if (it.grupo_codigo !== grupo.grupo_codigo) return false;
                if (query) {
                    const searchable = `${it.codigo || ''} ${it.cod_barras || ''} ${it.descricao || ''}`.toLowerCase();
                    if (!searchable.includes(query)) return false;
                }
                switch (activeFilter) {
                    case 'falta': if (it.faltou !== true) return false; break;
                    case 'obs': if (!it.observacao || it.observacao.trim() === '') return false; break;
                }
                return true;
            });

            if (itensFiltrados.length === 0) return;
            
            groupCounter++; // Aumenta o contador para cada grupo que ser√° exibido
            const nomeSeparador = grupo.separador_nome || '';
            
            html += `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div class="fs-5 grupo-titulo d-flex align-items-center gap-3">
                            <span class="group-number">${groupCounter}</span>
                            <div>
                                <strong class="fw-bold me-1">${grupo.grupo_codigo}</strong>
                                <span>${grupo.grupo_titulo || ''}</span>
                            </div>
			            </div>
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <div class="input-group input-group-sm" style="width: auto;">
                                <span class="input-group-text">Separador:</span>
                                <input type="text" class="form-control" id="separador-${grupo.grupo_codigo}" value="${nomeSeparador}" style="min-width: 120px;">
                                <button class="btn btn-outline-info" onclick="salvarSeparador('${grupo.grupo_codigo}')">Salvar</button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-success" onclick="marcarGrupo('${grupo.grupo_codigo}', true)">Marcar</button>
                                <button class="btn btn-outline-light" onclick="marcarGrupo('${grupo.grupo_codigo}', false)">Desmarcar</button>
                            </div>
                        </div>
                    </div>
                    <div class="list-group list-group-flush">`;

            itensFiltrados.forEach(it => {
                total++;
                if (it.separado) marcados++;
                let itemClasses = "list-group-item d-flex flex-column flex-md-row justify-content-between gap-3 p-3";
                if (it.separado) itemClasses += " separado";
                if (it.faltou) itemClasses += " faltou";
                if (it.pendente) itemClasses += " pendente";
                const descCompleta = [it.cod_barras, it.codigo, it.descricao, it.fabricante].filter(Boolean).join(' ');
                const qtdPedida = `${it.qtd_unidades || ''} ${it.unidade || ''} ${it.pack_qtd > 1 ? `(C/${it.pack_qtd})` : ''}`.trim();
                const qtdInfo = it.faltou && it.qtd_separada != null ?
                    `<span class="text-danger">Separado: ${it.qtd_separada} de ${it.qtd_unidades}</span>` :
                    `<span class="text-info">${qtdPedida}</span>`;
                const obsInfo = it.observacao ? `<div class="small text-warning mt-2"><strong>OBS:</strong> ${it.observacao}</div>` : '';
                html += `
                    <div class="${itemClasses}" id="item-${it.id}">
                        <div class="flex-grow-1">
                            <div class="small-mono">${descCompleta}</div>
                            <div class="fw-bold">${qtdInfo}</div>
                            ${obsInfo}
                            <div class="mt-2">
                                ${it.separado ? badge('Separado', 'bg-success') : ''}
                                ${it.faltou ? badge('Faltou', 'bg-danger') : ''}
                                ${it.pendente ? badge('Pendente', 'bg-warning text-dark') : ''}
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-3 align-items-center">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" ${it.separado ? 'checked' : ''} onchange="atualizarItem(${it.id}, { separado: this.checked, pendente: false, observacao: '' })">
                                <label class="form-check-label ${it.separado ? 'text-success fw-bold' : 'text-secondary'}">OK</label>
                            </div>
                            <button class="btn btn-sm btn-warning" onclick="abrirModalFaltou(${it.id})">Faltou</button>
                            <button class="btn btn-sm btn-info text-dark" onclick="marcarPendente(${it.id}, ${!it.pendente})">OBS</button>
                        </div>
                    </div>`;
            });
            html += `</div></div>`;
        });
        container.innerHTML = html || '<div class="alert alert-secondary">Nenhum item encontrado. Verifique a busca e o filtro selecionado.</div>';
        document.getElementById('resumo').textContent = total > 0 ? `${marcados} de ${total} itens marcados.` : '';
    }
    function abrirModalFaltou(itemId) {
        const item = STATE.itens.find(it => it.id === itemId);
        if (!item) return;
        document.getElementById('modal-produto-nome').textContent = item.descricao || 'N/D';
        document.getElementById('modal-qtd-pedida').textContent = `${item.qtd_unidades || 0} ${item.unidade || ''}`;
        document.getElementById('modal-qtd-separada').value = item.qtd_separada || '';
        document.getElementById('modal-item-id').value = itemId;
        document.getElementById('modal-observacao').value = item.observacao || '';
        modalFaltou.show();
    }
    async function salvarFalta() {
        const itemId = parseInt(document.getElementById('modal-item-id').value, 10);
        const qtdSeparadaInput = document.getElementById('modal-qtd-separada').value;
        const observacao = document.getElementById('modal-observacao').value.trim();
        if (qtdSeparadaInput === '' || isNaN(parseInt(qtdSeparadaInput, 10))) {
            alert('Por favor, insira uma quantidade num√©rica v√°lida.');
            return;
        }
        const qtdSeparada = parseInt(qtdSeparadaInput, 10);
        const item = STATE.itens.find(it => it.id === itemId);
        if (!item) { alert('Erro: Item n√£o encontrado.'); return; }
        const qtdPedida = item.qtd_unidades || 0;
        const patch = {
            qtd_separada: qtdSeparada,
            faltou: qtdSeparada < qtdPedida,
            separado: true,
            pendente: false,
            observacao: observacao
        };
        await atualizarItem(itemId, patch);
        modalFaltou.hide();
    }
    async function marcarPendente(itemId, pendente) {
        const item = STATE.itens.find(it => it.id === itemId);
        if (!item) return;
        const patch = {
            pendente: pendente,
            separado: false, 
            faltou: false,   
            qtd_separada: null,
            observacao: pendente ? (item.observacao || 'Item n√£o encontrado pelo separador.') : ''
        };
        await atualizarItem(itemId, patch);
    }
    async function salvarSeparador(grupoCodigo) {
        const input = document.getElementById(`separador-${grupoCodigo}`);
        const nome = input.value;
        const grupo = STATE.grupos.find(g => g.grupo_codigo === grupoCodigo);
        if(grupo) grupo.separador_nome = nome;
        await fetch('/api/mapa/grupo/definir-separador', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                numero_carga: NUMERO_CARGA,
                grupo_codigo: grupoCodigo,
                separador_nome: nome 
            })
        });
        input.classList.add('is-valid');
        setTimeout(() => input.classList.remove('is-valid'), 2000);
    }
    async function atualizarItem(itemId, patch) {
        const item = STATE.itens.find(it => it.id === itemId);
        if (item) Object.assign(item, patch);
        renderItens();
        const response = await fetch('/api/mapa/item/atualizar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id: itemId, ...patch })
        });
        const data = await response.json();
        if (data.ok && data.updated_fields) {
            if (item) Object.assign(item, data.updated_fields);
            renderItens();
        }
    }
    async function marcarGrupo(grupoCodigo, separado) {
        STATE.itens.forEach(it => { 
            if (it.grupo_codigo === grupoCodigo) {
                it.separado = separado; 
                it.pendente = false; 
                it.faltou = false;   
                it.qtd_separada = null; 
                it.observacao = '';
            }
        });
        renderItens();
        await fetch('/api/mapa/grupo/marcar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numero_carga: NUMERO_CARGA, grupo_codigo: grupoCodigo, separado: separado })
        });
    }
    async function carregarDados() {
        try {
            const response = await fetch(`/api/mapa/${NUMERO_CARGA}`);
            if (!response.ok) throw new Error('Falha ao carregar os dados do mapa.');
            const data = await response.json();
            STATE.grupos = data.grupos || [];
            STATE.itens = data.itens || [];
            renderItens();
        } catch (error) {
            document.getElementById('grupos-container').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }
    function handleSearchInput() {
        if (activeFilter !== 'todos') {
            setFilter('todos');
        } else {
            renderItens();
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        modalFaltou = new bootstrap.Modal(document.getElementById('modalFaltou'));
        const themeToggle = document.getElementById('theme-toggle');
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'light') {
                themeToggle.innerHTML = 'üåô';
            } else {
                themeToggle.innerHTML = '‚òÄÔ∏è';
            }
        }
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        });
        document.getElementById('busca').addEventListener('input', handleSearchInput);
        const savedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);
        carregarDados();
        setFilter('todos');
    });
</script>
</body>
</html>