<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa {{ numero_carga }} (Visualização para Impressão)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: white;
            color: black;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 992px;
        }
        .sticky-top-bar, nav {
            display: none;
        }
        .card {
            background-color: white;
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .card-header {
            background-color: #f0f0f0;
            color: black;
            border-bottom: 1px solid #ddd;
            padding: 10px 15px;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .grupo-titulo {
            color: #333;
            font-weight: bold;
            font-size: 1.2em;
        }
        .list-group-item {
            background-color: white;
            border-top: 1px solid #eee;
            color: black;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .list-group-item:first-child {
            border-top: none;
        }
        .list-group-item.separado {
            background-color: #e6ffe6;
        }
        .list-group-item.faltou {
            background-color: #ffe6e6;
        }
        .list-group-item.pendente {
            background-color: #fff9e6;
        }
        /* ===== PONTO DA CORREÇÃO AQUI ===== */
        .small-mono {
            font-family: Arial, sans-serif;
            font-size: 1.3em; /* Aumentado de 1.1em para 1.3em */
            color: #333;
            font-weight: bold;
            flex-grow: 1;
        }
        /* =================================== */
        .fw-bold {
            font-weight: bold;
        }
        .text-info {
            color: #007bff;
        }
        .text-danger {
            color: #dc3545;
        }
        .text-warning {
            color: #ffc107;
        }
        .badge {
            font-size: 0.8em;
            padding: 0.3em 0.6em;
            border-radius: 0.25rem;
            margin-right: 5px;
        }
        .badge.bg-success { background-color: #28a745 !important; color: white !important; }
        .badge.bg-danger { background-color: #dc3545 !important; color: white !important; }
        .badge.bg-warning { background-color: #ffc107 !important; color: black !important; }
        
        .form-check-switch, .d-flex.flex-wrap.gap-3.align-items-center > button, .input-group {
            display: none;
        }
        .separador-info {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }
        .obs-vazia {
            display: none;
        }

        @media print {
            .card {
                page-break-inside: avoid;
            }
            .list-group-item {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

<div class="container py-3">
    <h3 class="mb-4 text-center">
        Mapa de Separação: {{ nome_mapa or 'Mapa' }} <span class="text-info">{{ numero_carga }}</span>
    </h3>

    <div id="grupos-container" class="mt-3">
        <p class="text-center text-secondary">Carregando dados para impressão...</p>
    </div>

    <hr class="mt-5 mb-3">
    <p class="text-center small text-secondary">Gerado em: <span id="data-geracao"></span></p>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const NUMERO_CARGA = {{ numero_carga | tojson }};
    let STATE = { grupos: [], itens: [] };

    function badge(text, className) { return `<span class="badge ${className} me-1">${text}</span>`; }

    function renderItens() {
        const container = document.getElementById('grupos-container');
        let html = '';

        STATE.grupos.forEach(grupo => {
            const itensDoGrupo = STATE.itens.filter(it => it.grupo_codigo === grupo.grupo_codigo);

            if (itensDoGrupo.length === 0) return;

            const nomeSeparador = grupo.separador_nome || 'Não atribuído';

            html += `
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="grupo-titulo">
    			            ${grupo.grupo_codigo} &mdash; ${grupo.grupo_titulo || 'Sem Título'}
			            </div>
                        <div class="separador-info">Separador: ${nomeSeparador}</div>
                    </div>
                    <div class="list-group list-group-flush">`;

            itensDoGrupo.forEach(it => {
                let itemClasses = "list-group-item";
                if (it.separado) itemClasses += " separado";
                if (it.faltou) itemClasses += " faltou";
                if (!it.separado && !it.faltou) itemClasses += " pendente";


                const descCompleta = [it.cod_barras, it.codigo, it.descricao, it.fabricante].filter(Boolean).join(' ');
                const qtdPedida = `${it.qtd_unidades || ''} ${it.unidade || ''} ${it.pack_qtd > 1 ? `(C/${it.pack_qtd})` : ''}`.trim();
                
                let qtdExibida = `<span class="text-info fw-bold">${qtdPedida}</span>`;
                if (it.faltou && it.qtd_separada != null) {
                    qtdExibida = `<span class="text-danger fw-bold">Separado: ${it.qtd_separada} de ${it.qtd_unidades}</span>`;
                }

                const obsInfo = it.observacao ? `<div class="small text-warning mt-1"><strong>OBS:</strong> ${it.observacao}</div>` : `<div class="obs-vazia"></div>`;

                html += `
                    <div class="${itemClasses}" id="item-${it.id}">
                        <div class="flex-grow-1">
                            <div class="small-mono">${descCompleta}</div>
                            <div class="mt-1">${qtdExibida}</div>
                            ${obsInfo}
                        </div>
                        </div>`;
            });
            html += `</div></div>`;
        });

        container.innerHTML = html || '<div class="alert alert-secondary">Nenhum item encontrado para este mapa.</div>';
        
        document.getElementById('data-geracao').textContent = new Date().toLocaleString('pt-BR');
    }

    async function carregarDados() {
        try {
            const response = await fetch(`/api/mapa/${NUMERO_CARGA}`);
            if (!response.ok) throw new Error('Falha ao carregar os dados do mapa.');
            const data = await response.json();
            STATE.grupos = data.grupos || [];
            STATE.itens = data.itens || [];
            renderItens();
        } catch (error) {
            document.getElementById('grupos-container').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        carregarDados();
    });
</script>
</body>
</html>