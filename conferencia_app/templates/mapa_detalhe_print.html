<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa {{ numero_carga }} (Visualização para Impressão)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: white; /* Fundo branco */
            color: black; /* Texto preto */
            font-family: Arial, sans-serif; /* Fonte mais comum para impressão */
        }
        .container {
            max-width: 992px; /* Largura para impressão */
        }
        .sticky-top-bar, nav {
            display: none; /* Esconde a barra superior e navegação em modo de impressão */
        }
        .card {
            background-color: white;
            border: 1px solid #ddd; /* Borda suave */
            margin-bottom: 15px;
        }
        .card-header {
            background-color: #f0f0f0; /* Fundo cinza claro para o cabeçalho do grupo */
            color: black;
            border-bottom: 1px solid #ddd;
            padding: 10px 15px;
            font-size: 1.1rem;
            display: flex; /* Para alinhar bem os elementos do header */
            justify-content: space-between;
            align-items: center;
        }
        .grupo-titulo {
            color: #333; /* Cor mais escura para o título do grupo */
            font-weight: bold;
            font-size: 1.2em; /* Título do grupo um pouco maior */
        }
        .list-group-item {
            background-color: white;
            border: 1px solid #eee; /* Borda mais clara entre itens */
            color: black;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Para responsividade */
        }
        .list-group-item.separado {
            background-color: #e6ffe6; /* Verde claro para separado */
        }
        .list-group-item.faltou {
            background-color: #ffe6e6; /* Vermelho claro para falta */
        }
        .list-group-item.pendente {
            background-color: #fff9e6; /* Amarelo claro para pendente */
        }
        .small-mono {
            font-family: Arial, sans-serif; /* Descrição com fonte normal */
            font-size: 1.1em; /* Descrição maior */
            color: #333; /* Preto mais suave para descrição */
            font-weight: normal;
            flex-grow: 1; /* Permite que o texto ocupe mais espaço */
        }
        .fw-bold {
            font-weight: bold;
        }
        .text-info {
            color: #007bff; /* Azul padrão para quantidades */
        }
        .text-danger {
            color: #dc3545; /* Vermelho padrão para quantidades com falta */
        }
        .text-warning {
            color: #ffc107; /* Amarelo padrão para observações */
        }
        .badge {
            font-size: 0.8em;
            padding: 0.3em 0.6em;
            border-radius: 0.25rem;
            margin-right: 5px;
        }
        .badge.bg-success { background-color: #28a745 !important; color: white !important; }
        .badge.bg-danger { background-color: #dc3545 !important; color: white !important; }
        .badge.bg-warning { background-color: #ffc107 !important; color: black !important; }
        
        /* Oculta os controles de interação (checkbox, botões) na versão de impressão */
        .form-check-switch, .d-flex.flex-wrap.gap-3.align-items-center > button, .input-group {
            display: none;
        }

        /* Ajustes para o motorista/separador */
        .separador-info {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }

        /* Estilo para quando a observação está vazia, para não aparecer */
        .obs-vazia {
            display: none;
        }
    </style>
</head>
<body>

<div class="container py-3">
    <h3 class="mb-4 text-center">
        Mapa de Separação: {{ nome_mapa or 'Mapa' }} <span class="text-info">{{ numero_carga }}</span>
    </h3>

    <div id="grupos-container" class="mt-3">
        <p class="text-center text-secondary">Carregando dados para impressão...</p>
    </div>

    <hr class="mt-5 mb-3">
    <p class="text-center small text-secondary">Gerado em: <span id="data-geracao"></span></p>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const NUMERO_CARGA = {{ numero_carga | tojson }};
    let STATE = { grupos: [], itens: [] };

    function badge(text, className) { return `<span class="badge ${className} me-1">${text}</span>`; }

    function renderItens() {
        const container = document.getElementById('grupos-container');
        let html = '';

        STATE.grupos.forEach(grupo => {
            const itensDoGrupo = STATE.itens.filter(it => it.grupo_codigo === grupo.grupo_codigo);

            if (itensDoGrupo.length === 0) return;

            const nomeSeparador = grupo.separador_nome || 'Não atribuído';

            html += `
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="grupo-titulo">
    			            ${grupo.grupo_codigo} &mdash; ${grupo.grupo_titulo || 'Sem Título'}
			            </div>
                        <div class="separador-info">Separador: ${nomeSeparador}</div>
                    </div>
                    <div class="list-group list-group-flush">`;

            itensDoGrupo.forEach(it => {
                let itemClasses = "list-group-item";
                if (it.separado) itemClasses += " separado";
                if (it.faltou) itemClasses += " faltou";
                if (it.pendente) itemClasses += " pendente";

                const descCompleta = [it.cod_barras, it.codigo, it.descricao, it.fabricante].filter(Boolean).join(' ');
                const qtdPedida = `${it.qtd_unidades || ''} ${it.unidade || ''} ${it.pack_qtd > 1 ? `(C/${it.pack_qtd})` : ''}`.trim();
                
                let qtdExibida = `<span class="text-info fw-bold">${qtdPedida}</span>`;
                if (it.faltou && it.qtd_separada != null) {
                    qtdExibida = `<span class="text-danger fw-bold">Separado: ${it.qtd_separada} de ${it.qtd_unidades}</span>`;
                }

                // Exibição da observação (se houver)
                const obsInfo = it.observacao ? `<div class="small text-warning mt-1"><strong>OBS:</strong> ${it.observacao}</div>` : `<div class="obs-vazia"></div>`;

                html += `
                    <div class="${itemClasses}" id="item-${it.id}">
                        <div class="flex-grow-1">
                            <div class="small-mono">${descCompleta}</div>
                            <div class="mt-1">${qtdExibida}</div>
                            ${obsInfo}
                            <div class="mt-2">
                                ${it.separado ? badge('Separado', 'bg-success') : ''}
                                ${it.faltou ? badge('Faltou', 'bg-danger') : ''}
                                ${it.pendente ? badge('Pendente', 'bg-warning text-dark') : ''}
                            </div>
                        </div>
                        </div>`;
            });
            html += `</div></div>`;
        });

        container.innerHTML = html || '<div class="alert alert-secondary">Nenhum item encontrado para este mapa.</div>';

        // Define a data de geração
        document.getElementById('data-geracao').textContent = new Date().toLocaleString('pt-BR');
    }

    async function carregarDados() {
        try {
            const response = await fetch(`/api/mapa/${NUMERO_CARGA}`);
            if (!response.ok) throw new Error('Falha ao carregar os dados do mapa.');
            const data = await response.json();
            STATE.grupos = data.grupos || [];
            STATE.itens = data.itens || [];
            renderItens();
        } catch (error) {
            document.getElementById('grupos-container').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        carregarDados();
        // Em um cenário de impressão, você pode querer disparar a impressão automaticamente
        // window.print(); 
    });
</script>
</body>
</html>