{% extends 'base.html' %}

{% block title %}Hist√≥rico - Log√≠stica{% endblock %}

{% block content %}
<style>
  .setor-financeiro { color: #e74c3c; font-weight: bold; }
  .setor-faturamento { color: #2ecc71; font-weight: bold; }
  .setor-rh { color: #6c5ce7; font-weight: bold; }
  .setor-gerente { color: #b58900; font-weight: bold; }
</style>

<div class="container">
  <h2 class="mb-4">üöõ Hist√≥rico de Pontua√ß√£o - Log√≠stica</h2>

<!-- FILTROS (colar ap√≥s o <h2> e antes da tabela) -->
<form method="get" class="row g-2 mb-3">
  <!-- Motorista -->
  <div class="col-12 col-md-3">
    <label class="form-label">Motorista</label>
    <select name="motorista" class="form-select">
      <option value="">(Todos)</option>
      {% for m in motoristas %}
        <option value="{{ m }}" {{ 'selected' if motorista==m else '' }}>{{ m }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Respons√°vel -->
  <div class="col-12 col-md-3">
    <label class="form-label">Respons√°vel</label>
    <select name="responsavel" class="form-select">
      <option value="">(Todos)</option>
      <option value="FINANCEIRO"  {{ 'selected' if responsavel=='FINANCEIRO'  else '' }}>Financeiro</option>
      <option value="GERENTE_ADM" {{ 'selected' if responsavel=='GERENTE_ADM' else '' }}>Ger. ADM</option>
      <option value="RH"          {{ 'selected' if responsavel=='RH'          else '' }}>RH</option>
      <option value="FATURAMENTO" {{ 'selected' if responsavel=='FATURAMENTO' else '' }}>Faturamento</option>
    </select>
    <small class="text-muted d-block">
      A/C = Financeiro ‚Ä¢ B = Ger. ADM ‚Ä¢ D = RH ‚Ä¢ E = Faturamento
    </small>
  </div>

  <!-- Per√≠odo -->
  <div class="col-6 col-md-2">
    <label class="form-label">In√≠cio</label>
    <input type="text" name="inicio" class="form-control" placeholder="dd/mm/aaaa" value="{{ inicio or '' }}">
  </div>
  <div class="col-6 col-md-2">
    <label class="form-label">Fim</label>
    <input type="text" name="fim" class="form-control" placeholder="dd/mm/aaaa" value="{{ fim or '' }}">
  </div>

  <!-- A√ß√µes -->
  <div class="col-6 col-md-1 d-flex align-items-end">
    <button class="btn btn-primary w-100" type="submit">Filtrar</button>
  </div>
  <div class="col-6 col-md-1 d-flex align-items-end">
    <a class="btn btn-secondary w-100" href="{{ request.path }}">Limpar</a>
  </div>
</form>

  <div class="table-responsive">
    <table class="table table-bordered text-white">
      <thead class="table-dark">
  <tr>
    <th>ID</th>
    <th>Data</th>
    <th>Motorista</th>
    <th>
      Entregas conclu√≠das 100%<br>
      <span class="setor-financeiro">(Financeiro)</span>
    </th>
    <th>
      Ve√≠culo limpo e organizado<br>
      <span class="setor-gerente">(Gerente ADM)</span>
    </th>
    <th>
      Acerto organizado e correto<br>
      <span class="setor-financeiro">(Financeiro)</span>
    </th>
    <th>
      Quest√µes em rela√ß√£o √† jornada<br>
      <span class="setor-rh">(RH)</span>
    </th>
    <th>
      Erro do entregador<br>
      <span class="setor-faturamento">(Faturamento)</span>
    </th>
    <th>Extras</th>
    <th>Observa√ß√£o</th>
    <th>Total</th>
  </tr>
</thead>

<tbody>
  {% set ns = namespace(total_geral=0) %}
  {% for r in registros %}
    {% set extras = r[8].split(',') if r[8] else [] %}
    {% set total_parcial = (r[3]|int) + (r[4]|int) + (r[5]|int) + (r[6]|int) + (r[7]|int) %}
    {% if 'meta' in extras %} {% set total_parcial = total_parcial + 2 %} {% endif %}
    {% if 'equipe90' in extras %} {% set total_parcial = total_parcial + 1 %} {% endif %}
    {% if 'economia' in extras %} {% set total_parcial = total_parcial + 2 %} {% endif %}
    {% set ns.total_geral = ns.total_geral + total_parcial %}
    <tr>
      <td>{{ r[0] }}</td>  <!-- ID -->
      <td>{{ r[1]|datetimeformat }}</td>  <!-- Data -->
      <td>{{ r[2] }}</td>  <!-- Motorista -->
      <td>{{ r[3] }}</td>  <!-- Entregas 100% -->
      <td>{{ r[4] }}</td>  <!-- Ve√≠culo limpo -->
      <td>{{ r[5] }}</td>  <!-- Acerto correto -->
      <td>{{ r[6] }}</td>  <!-- Jornada -->
      <td>{{ r[7] }}</td>  <!-- Erro entregador -->
      <td>
        {% for extra in extras %}
          {% if extra == 'meta' %}
            ‚≠ê Meta di√°ria batida / Convers√£o 70%<br>
          {% elif extra == 'equipe90' %}
            ü§ù Equipe chegou a 90% da meta geral<br>
          {% elif extra == 'economia' %}
            ‚õΩ Economia de combust√≠vel 10% geral<br>
          {% endif %}
        {% endfor %}
      </td>
      <td>{{ r[9] if r[9] and r[9]|string|lower != 'nan' else '' }}</td>  <!-- Observa√ß√£o -->
      <td>{{ total_parcial }}</td>
    </tr>
  {% endfor %}
</tbody>

      <tfoot class="table-dark">
  <tr>
    <td colspan="10" class="text-end fw-bold">Total Geral:</td>
    <td class="fw-bold {% if ns.total_geral >= 0 %}text-success{% else %}text-danger{% endif %}">
      {{ ns.total_geral }}
    </td>
  </tr>
  <tr>
    <td colspan="10" class="text-end fw-bold">M√©dia:</td>
    <td class="fw-bold text-info">{{ media }}</td>
  </tr>
</tfoot>

    </table>
  </div>

  <a href="{{ url_for('home_pontuacao') }}" class="btn btn-secondary mt-3">üîô Voltar</a>
</div>
{% endblock %}
